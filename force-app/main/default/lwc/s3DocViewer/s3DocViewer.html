<template>
  <!-- ───────── CARD HEADER ───────── -->
  <lightning-card title={labels.documents} icon-name="custom:custom18">
    <lightning-button slot="actions"
                      variant="brand"
                      label={labels.uploadFile}
                      onclick={openModal}>
    </lightning-button>

    <!-- ========== LIST MODE ========== -->
    <template if:true={showList}>

      <!-- ────────── UPLOAD MODAL ────────── -->
      <template if:true={showModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
          <div class="slds-modal__container">
            <header class="slds-modal__header">
              <h2 class="slds-modal__title">{labels.uploadS3Document}</h2>
            </header>

            <div class="slds-modal__content slds-p-around_medium">
              <!-- PICKER  +  PREVIEW / CLEAR -->
              <div class="slds-grid slds-gutters_small slds-grid_vertical-align-center">

                <!-- choose / drop -->
                <div class="slds-col">
                  <input data-id="fileinput"
                         type="file"
                         accept=".txt,.pdf,.png,.jpg,.jpeg,.docx,.msg,.eml,.gif"
                         onchange={handleFileChange}/>
                </div>

                <!-- preview + ×  (non-images) -->
                <template if:true={previewFileUrl}>
                  <div class="slds-col slds-grid slds-gutters_small slds-align-center">
                    <lightning-button variant="base"
                                      icon-name="utility:preview"
                                      label={labels.preview}
                                      onclick={openLocalPreview}>
                    </lightning-button>

                    <button class="slds-button slds-button_icon"
                            title={labels.removeSelectedFile}
                            onclick={clearSelectedFile}>
                      <lightning-icon icon-name="utility:close"
                                      size="x-small"
                                      alternative-text={labels.remove}>
                      </lightning-icon>
                    </button>
                  </div>
                </template>

                <!-- thumbnail + ×  (images) -->
                <template if:true={previewImageUrl}>
                  <div class="slds-col slds-grid slds-align-center">
                    <div class="slds-is-relative">
                      <img src={previewImageUrl}
                           onload={measureBrightness}
                           alt="preview"
                           style="max-width:150px;max-height:150px"/>

                      <button class={closeBtnClass}
                              style="top:0.25rem;right:0.25rem"
                              onclick={clearSelectedFile}>×
                      </button>
                    </div>
                  </div>
                </template>

              </div>

              <!-- META FIELDS -->
              <template if:true={selectedFile}>
                <lightning-input type="text"
                                 label={labels.fileName}
                                 value={editFileName}
                                 onchange={handleEditFileName}>
                </lightning-input>

                <p><b>{labels.typeLabel}:</b> {selectedFile.type}</p>
                <p><b>{labels.sizeLabel}:</b> {selectedFile.size} bytes</p>
              </template>

              <lightning-input type="text"
                               label={labels.descriptionLabel}
                               value={newDescription}
                               onchange={handleNewDescriptionChange}>
              </lightning-input>

              <lightning-input type="date"
                               label={labels.creationDate}
                               value={newCreationDate}
                               onchange={handleNewDate}>
              </lightning-input>

              <!-- look-ups (conditional) -->
              <template if:true={showOppLookup}>
                <lightning-combobox label={labels.linkOpportunity}
                                    options={opportunityOptions}
                                    value={newOpportunityId}
                                    placeholder="(Optional)"
                                    onchange={handleOpportunityChange}>
                </lightning-combobox>
              </template>

              <template if:true={showCaseLookup}>
                <lightning-combobox label={labels.linkCase}
                                    options={caseOptions}
                                    value={newCaseId}
                                    placeholder="(Optional)"
                                    onchange={handleCaseChange}>
                </lightning-combobox>
              </template>

              <template if:true={showContactLookup}>
                <lightning-combobox label={labels.linkContact}
                                    options={contactOptions}
                                    value={newContactId}
                                    placeholder="(Optional)"
                                    onchange={handleContactChange}>
                </lightning-combobox>
              </template>

              <lightning-input type="text"
                               label={labels.linkTask}
                               placeholder="(Optional)"
                               value={newTaskId}
                               onchange={handleTaskChange}>
              </lightning-input>

              <template if:true={uploadMessage}>
                <div style="color:red;margin-top:5px">{uploadMessage}</div>
              </template>
            </div>

            <footer class="slds-modal__footer">
              <lightning-button variant="neutral"
                                label={labels.cancel}
                                onclick={closeModal}>
              </lightning-button>
              <lightning-button variant="brand"
                                label={labels.upload}
                                onclick={uploadFile}
                                disabled={isUploading}>
              </lightning-button>
            </footer>
          </div>

          <!-- ─── LOCAL PREVIEW (inside modal) ─── -->
          <template if:true={showUploadPreview}>
            <section class="slds-modal slds-fade-in-open" style="z-index:2">
              <div class="slds-modal__container" style="max-width:90vw;width:90vw">
                <header class="slds-modal__header">
                  <button class="slds-button slds-button_icon slds-modal__close"
                          title={labels.close}
                          onclick={closeUploadPreview}>
                    <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                    <span class="slds-assistive-text">{labels.close}</span>
                  </button>
                  <h2 class="slds-modal__title slds-hyphenate">{selectedFile.name}</h2>
                </header>

                <div class="slds-modal__content" style="max-height:70vh">
                  <!-- error -->
                  <template if:true={upError}>
                    <p class="slds-text-color_error">{upError}</p>
                  </template>

                  <!-- image -->
                  <template if:true={isUploadImage}>
                    <img src={upSrc} style="max-width:100%">
                  </template>

                  <!-- pdf -->
                  <template if:true={isUploadPdf}>
                    <c-pdf-viewer src={upSrc}></c-pdf-viewer>
                  </template>

                  <!-- docx -->
                  <template if:true={isUploadDocx}>
                    <c-docx-viewer src={upSrc}></c-docx-viewer>
                  </template>

                  <!-- eml / html -->
                  <template if:true={upHtml}>
                    <lightning-formatted-rich-text value={upHtml}></lightning-formatted-rich-text>
                  </template>

                  <!-- plain text -->
                  <template if:true={upText}>
                    <pre style="white-space:pre-wrap">{upText}</pre>
                  </template>

                  <!-- attachments -->
                  <template if:true={upAttachments.length}>
                    <h3 class="slds-text-heading_small slds-m-top_medium">{labels.attachments}</h3>
                    <ul class="slds-list_dotted">
                      <template for:each={upAttachments} for:item="a">
                        <li key={a.name} class="slds-m-vertical_x-small">
                          <a href={a.url} target="_blank">{a.name}</a>
                        </li>
                      </template>
                    </ul>
                  </template>
                </div>
              </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open" style="z-index:1"></div>
          </template>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
      </template>
      <!-- ────────── END UPLOAD MODAL ────────── -->

      <!-- ==========  SEARCH ROWS  ========== -->
      <!-- NAME row -->
      <div class="slds-p-around_x-small slds-m-bottom_xx-small
                  slds-grid slds-gutters">
        <label class="slds-form-element__label slds-size_1-of-12 slds-m-left-small slds-align-middle">
          {labels.fileName}
        </label>

        <lightning-combobox variant="label-hidden"
                            value={nameMode}
                            options={modeOptions}
                            onchange={handleNameMode}
                            class="slds-size_1-of-12">
        </lightning-combobox>

        <lightning-input type="search" variant="label-hidden"
                         placeholder={labels.searchFileName}
                         value={nameKey}
                         onchange={handleNameKey}
                         class="slds-size_6-of-12">
        </lightning-input>

        <div class="slds-size_4-of-12 slds-text-align_right">
          <lightning-button variant="base"
                            label={labels.advancedFilters}
                            icon-name="utility:filterList"
                            onclick={toggleFilters}>
          </lightning-button>
        </div>
      </div>

      <!-- DESCRIPTION row -->
      <div class="slds-p-around_x-small slds-m-bottom_xx-small
                  slds-grid slds-gutters">
        <label class="slds-form-element__label slds-size_1-of-12 slds-align-middle">
          {labels.descriptionLabel}
        </label>

        <lightning-combobox variant="label-hidden"
                            value={descMode}
                            options={modeOptions}
                            onchange={handleDescMode}
                            class="slds-size_1-of-12">
        </lightning-combobox>

        <lightning-input type="search" variant="label-hidden"
                         placeholder={labels.searchDescription}
                         value={descKey}
                         onchange={handleDescKey}
                         class="slds-size_6-of-12">
        </lightning-input>

        <div class="slds-size_4-of-12 slds-text-align_right">
          <template if:true={hasVisibleOptionals}>
            <template if:false={showFilters}>
              <lightning-button label={buttonLabel}
                                variant="base"
                                title="Show / hide more columns"
                                onclick={toggleColumns}>
              </lightning-button>
            </template>
          </template>
        </div>
      </div>

      <!-- FILTER ROW -->
      <template if:true={showFilters}>
        <div class="slds-p-around_x-small slds-grid slds-gutters">

          <lightning-combobox placeholder={labels.typeLabel}
                              label={labels.typeLabel}
                              value={typeFilter}
                              options={typeOptions}
                              onchange={handleTypeChange}
                              variant="label-hidden"
                              class="slds-size_2-of-12">
          </lightning-combobox>

          <lightning-input type="date" label={labels.dateGE}
                           value={dateFrom}
                           onchange={handleDateFrom}
                           variant="label-hidden"
                           class="slds-size_2-of-12"
                           placeholder={labels.dateGE}>
          </lightning-input>

          <lightning-input type="date" label={labels.dateLE}
                           value={dateTo}
                           onchange={handleDateTo}
                           variant="label-hidden"
                           class="slds-size_2-of-12"
                           placeholder={labels.dateLE}>
          </lightning-input>

          <lightning-input type="number" variant="label-hidden"
                           placeholder={labels.sizeGE}
                           value={sizeMin}
                           onchange={handleSizeMin}
                           class="slds-size_2-of-12">
          </lightning-input>

          <lightning-input type="number" variant="label-hidden"
                           placeholder={labels.sizeLE}
                           value={sizeMax}
                           onchange={handleSizeMax}
                           class="slds-size_2-of-12">
          </lightning-input>

          <template if:true={hasVisibleOptionals}>
            <div class="slds-size_2-of-12 slds-text-align_right">
              <lightning-button label={buttonLabel}
                                variant="base"
                                title="Show / hide more columns"
                                onclick={toggleColumns}>
              </lightning-button>
            </div>
          </template>
        </div>
      </template>

      <!-- error banner -->
      <template if:true={error}>
        <div class="slds-text-color_error slds-m-around_small">{error}</div>
      </template>

      <!-- DATATABLE -->
      <div class="slds-scrollable_x">
        <lightning-datatable key-field="Id"
                             data={filteredAndSortedDocs}
                             columns={columns}
                             sorted-by={sortBy}
                             sorted-direction={sortDirection}
                             onsort={handleSort}
                             onrowaction={handleRowAction}
                             onsave={handleSave}
                             hide-checkbox-column
                             style="min-width:1400px">
        </lightning-datatable>
      </div>

      <!-- PAGINATION -->
      <div class="slds-grid slds-grid_vertical-align-center slds-p-around_x-small">
        <lightning-combobox label={labels.rows}
                            value={pageSize}
                            options={pageSizeOptions}
                            onchange={handlePageSize}
                            variant="label-hidden"
                            class="slds-size_1-of-8">
        </lightning-combobox>

        <lightning-button-icon icon-name="utility:chevronleft"
                               alternative-text={labels.previous}
                               onclick={prevPage}
                               disabled={disablePrev}
                               class="slds-m-horizontal_x-small">
        </lightning-button-icon>

        <div>{pageNumber} / {pageCount}</div>

        <lightning-button-icon icon-name="utility:chevronright"
                               alternative-text={labels.next}
                               onclick={nextPage}
                               disabled={disableNext}
                               class="slds-m-horizontal_x-small">
        </lightning-button-icon>
      </div>
    </template>
    <!-- ========== END LIST MODE ========== -->

    <!-- ========== PREVIEW MODE ========== -->
    <template if:true={showPreview}>
      <!-- header -->
      <div class="slds-p-around_small slds-grid slds-grid_vertical-align-start"
           style="position:relative">
        <lightning-button-icon icon-name="utility:back"
                               size="small"
                               alternative-text={labels.back}
                               onclick={closePreview}>
        </lightning-button-icon>

        <h2 class="slds-text-heading_small slds-m-left_small">{previewName}</h2>

        <lightning-button-icon icon-name="utility:download"
                               size="small"
                               alternative-text={labels.download}
                               title={labels.download}
                               onclick={downloadFile}
                               style="position:absolute; right:0.5rem"
                               false={previewError}>
        </lightning-button-icon>
      </div>

      <!-- body -->
      <div class="slds-scrollable_y" style="max-height:60vh">
        <template if:true={previewError}>
          <p class="slds-text-color_error slds-p-horizontal_small">{previewError}</p>
        </template>

        <!-- image -->
        <template if:true={isImage}>
          <img src={previewSrc} style="max-width:100%;">
        </template>

        <!-- text -->
        <template if:true={isText}>
          <pre class="slds-p-horizontal_small" style="white-space:pre-wrap">
{previewText}
          </pre>
        </template>

        <!-- pdf -->
        <template if:true={isPdf}>
          <c-pdf-viewer src={previewSrc}></c-pdf-viewer>
        </template>

        <!-- docx -->
        <template if:true={isDocx}>
          <c-docx-viewer src={previewSrc}></c-docx-viewer>
        </template>

        <!-- msg / eml -->
        <template if:true={previewHtml}>
          <div class="slds-p-horizontal_small">
            <lightning-formatted-rich-text value={previewHtml}></lightning-formatted-rich-text>
          </div>

          <template if:true={previewAttachments.length}>
            <h3 class="slds-text-heading_small slds-m-top_medium slds-p-horizontal_small">
              {labels.attachments}
            </h3>
            <ul class="slds-list_dotted slds-p-horizontal_small">
              <template for:each={previewAttachments} for:item="att">
                <li key={att.id} class="slds-m-vertical_x-small">
                  <a href="javascript:void(0);" data-url={att.url} onclick={openAttachment}>
                    {att.name}
                  </a>
                </li>
              </template>
            </ul>
          </template>
        </template>

        <!-- unsupported -->
        <template if:true={isOther}>
          <p class="slds-p-horizontal_small">{labels.previewNotSupported}</p>
        </template>
      </div>
    </template>

    <!-- spinner -->
    <template if:true={isLoading}>
      <lightning-spinner alternative-text={labels.loading}></lightning-spinner>
    </template>

  </lightning-card>
</template>
